name: Release Add-ins

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Package tray app
        run: npm run package:tray
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-tray-package
          path: build/copilot-office-addin-macos-*.zip
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Package tray app
        run: npm run package:tray

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-tray-package
          path: build/copilot-office-addin-windows-*.zip
          if-no-files-found: error

  create-release:
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create source zip (excluding private files)
        run: |
          mkdir -p artifacts
          zip -r artifacts/copilot-office-addin-source-v${{ github.event.inputs.version }}.zip . \
            -x ".github/*" \
            -x "package-lock.json" \
            -x "node_modules/*" \
            -x "build/*" \
            -x "dist/*" \
            -x ".git/*" \
            -x ".DS_Store" \
            -x "*.zip"
          
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-tray-package
          path: artifacts

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-tray-package
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release v${{ github.event.inputs.version }}
          body: |
            ## GitHub Copilot Office Add-in v${{ github.event.inputs.version }}
            
            Download the zip for your platform, extract it, then:
            
            ### Quick Start
            1. Run the register script once to trust the SSL certificate and register the manifest:
               - **macOS:** `./register.sh`
               - **Windows (PowerShell as Admin):** `.\register.ps1`
            2. Launch the app:
               - **macOS:** Double-click `GitHub Copilot Office Add-in.app`
               - **Windows:** Run `GitHub Copilot Office Add-in.exe`
            3. Open Word, PowerPoint, or Excel → **Insert** → **Add-ins** → **My Add-ins** → **GitHub Copilot**
            
            See `GETTING_STARTED.md` for detailed instructions.
            
            ### Source Code
            The source zip excludes CI workflows and lock files. Run `npm install` to install dependencies.
          files: artifacts/*.zip
          draft: false
          prerelease: false
